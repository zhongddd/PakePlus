"use strict";(self["webpackChunkclient"]=self["webpackChunkclient"]||[]).push([[264],{684:function(e){e.exports=function(e,t){var r="function"==typeof Iterator&&Iterator.prototype[e];if(r)try{r.call({next:null},t).next()}catch(a){return!0}}},1385:function(e,t,r){var a=r(9539);e.exports=function(e,t,r){for(var o=e.length-1;o>=0;o--)if(void 0!==e[o])try{r=a(e[o].iterator,t,r)}catch(l){t="throw",r=l}if("throw"===t)throw r;return r}},1701:function(e,t,r){var a=r(6518),o=r(9565),l=r(9306),i=r(8551),n=r(1767),s=r(9462),u=r(6319),c=r(9539),d=r(684),p=r(4549),m=r(6395),f=!m&&!d("map",function(){}),h=!m&&!f&&p("map",TypeError),g=m||f||h,_=s(function(){var e=this.iterator,t=i(o(this.next,e)),r=this.done=!!t.done;if(!r)return u(e,this.mapper,[t.value,this.counter++],!0)});a({target:"Iterator",proto:!0,real:!0,forced:g},{map:function(e){i(this);try{l(e)}catch(t){c(this,"throw",t)}return h?o(h,this,e):new _(n(this),{mapper:e})}})},2529:function(e){e.exports=function(e,t){return{value:e,done:t}}},6279:function(e,t,r){var a=r(6840);e.exports=function(e,t,r){for(var o in t)a(e,o,t[o],r);return e}},6319:function(e,t,r){var a=r(8551),o=r(9539);e.exports=function(e,t,r,l){try{return l?t(a(r)[0],r[1]):t(r)}catch(i){o(e,"throw",i)}}},7038:function(e,t,r){r.r(t),r.d(t,{default:function(){return k}});r(8111),r(1701);var a=r(641),o=r(33);const l={class:"product-publish-container"},i={class:"preview-images"},n={class:"image-info"};function s(e,t,r,s,u,c){const d=(0,a.g2)("el-button"),p=(0,a.g2)("el-alert"),m=(0,a.g2)("CozeWorkflowTester"),f=(0,a.g2)("el-collapse-item"),h=(0,a.g2)("el-collapse"),g=(0,a.g2)("el-option"),_=(0,a.g2)("el-select"),k=(0,a.g2)("el-form-item"),b=(0,a.g2)("el-input"),v=(0,a.g2)("el-input-number"),y=(0,a.g2)("el-image"),w=(0,a.g2)("el-checkbox"),F=(0,a.g2)("el-checkbox-group"),I=(0,a.g2)("el-radio"),T=(0,a.g2)("el-radio-group"),x=(0,a.g2)("el-date-picker"),V=(0,a.g2)("el-form"),$=(0,a.g2)("el-card"),C=(0,a.gN)("loading");return(0,a.uX)(),(0,a.CE)("div",l,[(0,a.bF)($,{class:"box-card"},{header:(0,a.k6)(()=>t[10]||(t[10]=[(0,a.Lk)("div",{class:"card-header"},[(0,a.Lk)("h2",null,"商品发布")],-1)])),default:(0,a.k6)(()=>[(0,a.bF)(h,{class:"coze-workflow-section"},{default:(0,a.k6)(()=>[(0,a.bF)(f,{title:"AI生成商品信息",name:"coze"},{default:(0,a.k6)(()=>[s.hasApiSettings?((0,a.uX)(),(0,a.Wv)(p,{key:1,type:"success","show-icon":"",closable:!1,style:{"margin-bottom":"15px"}},{default:(0,a.k6)(()=>t[13]||(t[13]=[(0,a.Lk)("p",null,"已成功加载全局API设置",-1)])),_:1,__:[13]})):((0,a.uX)(),(0,a.Wv)(p,{key:0,type:"warning","show-icon":"",closable:!1,style:{"margin-bottom":"15px"}},{default:(0,a.k6)(()=>[t[12]||(t[12]=(0,a.Lk)("p",null,'尚未配置Coze API设置，请先在"设置-API设置"页面中进行配置',-1)),(0,a.bF)(d,{type:"primary",size:"small",onClick:s.goToSettings,style:{"margin-top":"8px"}},{default:(0,a.k6)(()=>t[11]||(t[11]=[(0,a.eW)(" 前往设置页面 ")])),_:1,__:[11]},8,["onClick"])]),_:1,__:[12]})),s.hasApiSettings?((0,a.uX)(),(0,a.Wv)(m,{key:2,"api-settings":s.apiSettings,onResult:s.handleWorkflowResult},null,8,["api-settings","onResult"])):(0,a.Q3)("",!0)]),_:1})]),_:1}),(0,a.bo)(((0,a.uX)(),(0,a.Wv)(V,{ref:"formRef",model:s.form,rules:s.rules,"label-width":"120px"},{default:(0,a.k6)(()=>[(0,a.bF)(k,{label:"选择店铺",prop:"shop_id"},{default:(0,a.k6)(()=>[(0,a.bF)(_,{modelValue:s.form.shop_id,"onUpdate:modelValue":t[0]||(t[0]=e=>s.form.shop_id=e),placeholder:"请选择店铺",onChange:s.fetchShopAuthorize},{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.shops,e=>((0,a.uX)(),(0,a.Wv)(g,{key:e.id,label:e.shop_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),(0,a.bF)(k,{label:"商品标题",prop:"title"},{default:(0,a.k6)(()=>[(0,a.bF)(b,{modelValue:s.form.title,"onUpdate:modelValue":t[1]||(t[1]=e=>s.form.title=e),placeholder:"请输入商品标题"},null,8,["modelValue"])]),_:1}),(0,a.bF)(k,{label:"商品描述",prop:"description"},{default:(0,a.k6)(()=>[(0,a.bF)(b,{modelValue:s.form.description,"onUpdate:modelValue":t[2]||(t[2]=e=>s.form.description=e),type:"textarea",rows:4,placeholder:"请输入商品描述"},null,8,["modelValue"])]),_:1}),(0,a.bF)(k,{label:"商品价格",prop:"price"},{default:(0,a.k6)(()=>[(0,a.bF)(v,{modelValue:s.form.price,"onUpdate:modelValue":t[3]||(t[3]=e=>s.form.price=e),min:.01,precision:2,step:.01,"controls-position":"right"},null,8,["modelValue"]),t[14]||(t[14]=(0,a.Lk)("span",{class:"price-tip"},"单位：元",-1))]),_:1,__:[14]}),(0,a.bF)(k,{label:"商品图片",prop:"category_id",rules:[{required:!0,message:"请选择图片分类",trigger:"change"}]},{default:(0,a.k6)(()=>[(0,a.bF)(_,{modelValue:s.form.category_id,"onUpdate:modelValue":t[4]||(t[4]=e=>s.form.category_id=e),placeholder:"请选择图片分类",onChange:s.handleCategoryChange},{default:(0,a.k6)(()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.categories,e=>((0,a.uX)(),(0,a.Wv)(g,{key:e.id,label:`${e.name} (${e.image_count}张)`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),(0,a.bF)(k,{label:"图片数量",prop:"image_count"},{default:(0,a.k6)(()=>[(0,a.bF)(v,{modelValue:s.form.image_count,"onUpdate:modelValue":t[5]||(t[5]=e=>s.form.image_count=e),min:1,max:9,step:1,"controls-position":"right"},null,8,["modelValue"]),t[15]||(t[15]=(0,a.Lk)("span",{class:"price-tip"},"（1-9张随机图片）",-1))]),_:1,__:[15]}),s.previewImages.length>0?((0,a.uX)(),(0,a.Wv)(k,{key:0,label:"预览图片"},{default:(0,a.k6)(()=>[(0,a.Lk)("div",i,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.previewImages,(e,t)=>((0,a.uX)(),(0,a.CE)("div",{key:t,class:"preview-image-item"},[(0,a.bF)(y,{src:e.url,fit:"cover","preview-src-list":s.previewImages.map(e=>e.url),"initial-index":t},null,8,["src","preview-src-list","initial-index"]),(0,a.Lk)("div",n,(0,o.v_)(0===t?"主图":`图片${t+1}`),1)]))),128))]),(0,a.bF)(d,{type:"primary",size:"small",onClick:s.refreshRandomImages},{default:(0,a.k6)(()=>t[16]||(t[16]=[(0,a.eW)("重新随机")])),_:1,__:[16]},8,["onClick"])]),_:1})):(0,a.Q3)("",!0),(0,a.bF)(k,{label:"商品服务"},{default:(0,a.k6)(()=>[(0,a.bF)(F,{modelValue:s.form.services,"onUpdate:modelValue":t[6]||(t[6]=e=>s.form.services=e)},{default:(0,a.k6)(()=>[(0,a.bF)(w,{label:"SDR"},{default:(0,a.k6)(()=>t[17]||(t[17]=[(0,a.eW)("七天无理由退货")])),_:1,__:[17]}),(0,a.bF)(w,{label:"NFR"},{default:(0,a.k6)(()=>t[18]||(t[18]=[(0,a.eW)("描述不符包邮退")])),_:1,__:[18]}),(0,a.bF)(w,{label:"VNR"},{default:(0,a.k6)(()=>t[19]||(t[19]=[(0,a.eW)("描述不符全额退（虚拟类）")])),_:1,__:[19]}),(0,a.bF)(w,{label:"FD_10MS"},{default:(0,a.k6)(()=>t[20]||(t[20]=[(0,a.eW)("10分钟极速发货（虚拟类）")])),_:1,__:[20]}),(0,a.bF)(w,{label:"FD_24HS"},{default:(0,a.k6)(()=>t[21]||(t[21]=[(0,a.eW)("24小时极速发货")])),_:1,__:[21]}),(0,a.bF)(w,{label:"FD_48HS"},{default:(0,a.k6)(()=>t[22]||(t[22]=[(0,a.eW)("48小时极速发货")])),_:1,__:[22]}),(0,a.bF)(w,{label:"FD_GPA"},{default:(0,a.k6)(()=>t[23]||(t[23]=[(0,a.eW)("正品保障")])),_:1,__:[23]})]),_:1},8,["modelValue"]),t[24]||(t[24]=(0,a.Lk)("div",{class:"service-tips"},[(0,a.Lk)("p",null,"可多选，不选则不提供任何服务")],-1))]),_:1,__:[24]}),(0,a.bF)(k,{label:"上架时间设置"},{default:(0,a.k6)(()=>[(0,a.bF)(T,{modelValue:s.publishTimeType,"onUpdate:modelValue":t[7]||(t[7]=e=>s.publishTimeType=e)},{default:(0,a.k6)(()=>[(0,a.bF)(I,{value:"now"},{default:(0,a.k6)(()=>t[25]||(t[25]=[(0,a.eW)("立即上架")])),_:1,__:[25]}),(0,a.bF)(I,{value:"schedule"},{default:(0,a.k6)(()=>t[26]||(t[26]=[(0,a.eW)("定时上架")])),_:1,__:[26]})]),_:1},8,["modelValue"])]),_:1}),"schedule"===s.publishTimeType?((0,a.uX)(),(0,a.Wv)(k,{key:1,label:"定时上架时间",prop:"specify_publish_time"},{default:(0,a.k6)(()=>[(0,a.bF)(x,{modelValue:s.form.specify_publish_time,"onUpdate:modelValue":t[8]||(t[8]=e=>s.form.specify_publish_time=e),type:"datetime",placeholder:"选择定时上架时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss","disabled-date":s.disabledDate,"disabled-time":s.disabledTime},null,8,["modelValue","disabled-date","disabled-time"])]),_:1})):(0,a.Q3)("",!0),(0,a.bF)(k,{label:"回调通知URL",prop:"notify_url"},{default:(0,a.k6)(()=>[(0,a.bF)(b,{modelValue:s.form.notify_url,"onUpdate:modelValue":t[9]||(t[9]=e=>s.form.notify_url=e),placeholder:"请输入回调通知URL（可选）"},null,8,["modelValue"]),t[27]||(t[27]=(0,a.Lk)("div",{class:"url-tips"},[(0,a.Lk)("p",null,"如需接收上架结果通知，请填写回调URL")],-1))]),_:1,__:[27]}),(0,a.bF)(k,null,{default:(0,a.k6)(()=>[(0,a.bF)(d,{type:"primary",onClick:s.submitForm},{default:(0,a.k6)(()=>t[28]||(t[28]=[(0,a.eW)("发布商品")])),_:1,__:[28]},8,["onClick"]),(0,a.bF)(d,{onClick:s.resetForm},{default:(0,a.k6)(()=>t[29]||(t[29]=[(0,a.eW)("重置")])),_:1,__:[29]},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])),[[C,s.loading]])]),_:1})])}r(4114);var u=r(953),c=r(163),d=r(7918),p=r(5220),m=r(4783),f=r(1042),h={name:"ProductPublish",components:{CozeWorkflowTester:f.A},setup(){const e=(0,p.rd)(),t=(0,m.k)(),r=(0,u.KR)(null),o=(0,u.KR)(!1),l=(0,u.KR)([]),i=(0,u.KR)(null),n=(0,u.KR)([]),s=(0,u.KR)([]),f=(0,u.KR)("now"),h=(0,u.Kh)({cozeApiToken:"",workflowId:"",botId:""}),g=(0,a.EW)(()=>h.cozeApiToken&&h.workflowId),_=()=>{try{const e=localStorage.getItem("apiSettings");if(e){const t=JSON.parse(e);t.cozeApiToken&&(h.cozeApiToken=t.cozeApiToken),t.cozeWorkflowId&&(h.workflowId=t.cozeWorkflowId),t.cozeBotId&&(h.botId=t.cozeBotId)}}catch(e){console.error("加载API设置失败:",e)}},k=()=>{e.push({path:"/settings",query:{tab:"api"}})},b=e=>{if(e&&e.isCompleted&&e.parsedOutput)try{const t=e.parsedOutput.trim().split("\n");t.length>0&&(v.title=t[0].trim(),t.length>1&&(v.description=t.slice(1).join("\n").trim()),c.nk.success("已成功填充商品信息"))}catch(t){console.error("处理工作流结果失败:",t),c.nk.error("处理工作流结果失败")}},v=(0,u.Kh)({shop_id:"",title:"",description:"",price:9.9,images:[],category_id:"",image_count:3,specify_publish_time:"",notify_url:"",services:[]}),y={shop_id:[{required:!0,message:"请选择店铺",trigger:"change"}],title:[{required:!0,message:"请输入商品标题",trigger:"blur"},{min:3,max:60,message:"标题长度在3到60个字符之间",trigger:"blur"}],description:[{required:!0,message:"请输入商品描述",trigger:"blur"},{min:5,max:5e3,message:"描述长度在5到5000个字符之间",trigger:"blur"}],price:[{required:!0,message:"请输入商品价格",trigger:"blur"},{type:"number",min:.01,message:"价格必须大于0",trigger:"blur"}],category_id:[{required:!0,message:"请选择图片分类",trigger:"change"}],specify_publish_time:[{required:!0,message:"请选择定时上架时间",trigger:"change"}],notify_url:[{pattern:/^(https?:\/\/)?([\w.-]+)\.([a-zA-Z]{2,})(:\d+)?(\/\S*)?$/,message:"请输入有效的URL地址",trigger:"blur"}]},w=e=>e.getTime()<Date.now()-864e5,F=()=>{const e=new Date;return{disabledHours:()=>{const t=[];if(v.specify_publish_time&&v.specify_publish_time.split(" ")[0]===e.toISOString().split("T")[0])for(let r=0;r<e.getHours();r++)t.push(r);return t}}},I=async()=>{try{o.value=!0;const e=await fetch("/api/shops",{method:"GET",headers:{Authorization:`Bearer ${t.token}`}}),r=await e.json();!r.error&&r.data?(l.value=r.data,1===l.value.length&&(v.shop_id=l.value[0].id,await C())):c.nk.error(`获取店铺列表失败: ${r.message||"未知错误"}`)}catch(e){console.error("获取店铺列表异常:",e),c.nk.error("网络异常，请稍后重试")}finally{o.value=!1}},T=async()=>{try{o.value=!0;const e=await fetch("/api/image-categories",{headers:{Authorization:`Bearer ${t.token}`}});if(e.ok){const t=await e.json();!t.error&&t.data?n.value=t.data:c.nk.error("获取图片分类失败")}else c.nk.error("获取图片分类失败")}catch(e){console.error("获取图片分类异常:",e),c.nk.error("网络异常，请稍后重试")}finally{o.value=!1}},x=async()=>{if(v.category_id)try{const e=await fetch(`/api/images?category_id=${v.category_id}&limit=1`,{headers:{Authorization:`Bearer ${t.token}`}});if(e.ok){const t=await e.json();console.log("分类图片检查:",t),!1===t.error&&t.data&&t.data.images&&t.data.images.length>0?V():(c.nk.warning("该分类下没有图片，请先上传图片或选择其他分类"),s.value=[],v.images=[])}else console.error("检查分类图片失败:",await e.text()),V()}catch(e){console.error("检查分类图片数量异常:",e),V()}else s.value=[]},V=async()=>{if(v.category_id)try{o.value=!0;const e=await fetch(`/api/images/random?category_id=${v.category_id}&count=${v.image_count}`,{headers:{Authorization:`Bearer ${t.token}`}});if(e.ok){const t=await e.json();console.log("随机图片API响应:",t),!t.error&&t.data?(s.value=t.data,v.images=t.data.map(e=>e.url)):(c.nk.error(`获取随机图片失败: ${t.message||"未知错误"}`),console.error("获取随机图片失败:",t),s.value=[],v.images=[])}else{const t=await e.text();console.error("获取随机图片HTTP错误:",e.status,t),c.nk.error(`获取随机图片失败: ${e.status} ${e.statusText}`),s.value=[],v.images=[]}}catch(e){console.error("获取随机图片异常:",e),c.nk.error("网络异常，请稍后重试"),s.value=[],v.images=[]}finally{o.value=!1}},$=()=>{V()},C=async()=>{if(v.shop_id)try{o.value=!0;const e=await fetch(`/api/shops/${v.shop_id}`,{method:"GET",headers:{Authorization:`Bearer ${t.token}`}}),r=await e.json();if(r.error||!r.data)return void c.nk.error(`获取店铺信息失败: ${r.message||"未知错误"}`);const a=await fetch(`/api/shops/${v.shop_id}/query`,{method:"POST",headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json"}}),l=await a.json();!l.error&&l.data&&l.data.shops&&0!==l.data.shops.length?(i.value=l.data.shops[0],c.nk.success(`已连接到授权店铺: ${i.value.user_name}`)):(i.value=null,c.nk.error(`获取店铺授权信息失败: ${l.message||"未知错误"}`))}catch(e){console.error("获取店铺授权信息异常:",e),c.nk.error(`网络异常: ${e.message}`),i.value=null}finally{o.value=!1}},W=async()=>{r.value&&await r.value.validate(async r=>{if(r){if(0===v.images.length){if(!v.category_id)return void c.nk.error("请先选择图片分类");if(await V(),0===v.images.length)return void c.nk.error("无法获取图片，请选择其他分类")}if(!i.value)return void c.nk.error("请先选择并连接授权店铺");try{o.value=!0;const r={shopId:v.shop_id,title:v.title,description:v.description,price:v.price,images:v.images,services:v.services,publishOptions:{specifyPublishTime:"schedule"===f.value?v.specify_publish_time:null,notifyUrl:v.notify_url||null}},a=await fetch("/api/products",{method:"POST",headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json"},body:JSON.stringify(r)}),l=await a.json();if(l.error)throw new Error(`创建商品失败: ${l.message||"未知错误"}`);const i=l.data.productId;c.nk.success(`商品创建成功! 商品ID: ${i}`);const n=await d.s.confirm(`商品创建成功，商品ID: ${i}，是否立即发布?`,"发布确认",{confirmButtonText:"立即发布",cancelButtonText:"稍后发布",type:"success"}).catch(()=>!1);if(n){const r=await fetch(`/api/products/${i}/publish`,{method:"POST",headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json"},body:JSON.stringify({specifyPublishTime:"schedule"===f.value?v.specify_publish_time:null,notifyUrl:v.notify_url||null})}),a=await r.json();if(a.error)return void c.nk.error(`发布失败: ${a.message||"未知错误"}`);"schedule"===f.value?c.nk.success(`商品已设置定时上架，上架时间: ${v.specify_publish_time}`):c.nk.success("商品发布成功"),e.push("/publish-plans")}else e.push("/publish-plans")}catch(a){console.error("创建商品异常:",a),c.nk.error(`网络异常: ${a.message}`)}finally{o.value=!1}}else c.nk.error("请完善表单信息")})},z=()=>{r.value&&(r.value.resetFields(),v.images=[],v.services=[],s.value=[],f.value="now")};return(0,a.sV)(()=>{I(),T(),_()}),{formRef:r,form:v,rules:y,loading:o,shops:l,authorizedShop:i,categories:n,previewImages:s,publishTimeType:f,disabledDate:w,disabledTime:F,submitForm:W,resetForm:z,fetchShopAuthorize:C,handleCategoryChange:x,refreshRandomImages:$,apiSettings:h,hasApiSettings:g,handleWorkflowResult:b,goToSettings:k}}},g=r(6262);const _=(0,g.A)(h,[["render",s],["__scopeId","data-v-41a0325f"]]);var k=_},9462:function(e,t,r){var a=r(9565),o=r(2360),l=r(6699),i=r(6279),n=r(8227),s=r(1181),u=r(5966),c=r(7657).IteratorPrototype,d=r(2529),p=r(9539),m=r(1385),f=n("toStringTag"),h="IteratorHelper",g="WrapForValidIterator",_="normal",k="throw",b=s.set,v=function(e){var t=s.getterFor(e?g:h);return i(o(c),{next:function(){var r=t(this);if(e)return r.nextHandler();if(r.done)return d(void 0,!0);try{var a=r.nextHandler();return r.returnHandlerResult?a:d(a,r.done)}catch(o){throw r.done=!0,o}},return:function(){var r=t(this),o=r.iterator;if(r.done=!0,e){var l=u(o,"return");return l?a(l,o):d(void 0,!0)}if(r.inner)try{p(r.inner.iterator,_)}catch(i){return p(o,k,i)}if(r.openIters)try{m(r.openIters,_)}catch(i){return p(o,k,i)}return o&&p(o,_),d(void 0,!0)}})},y=v(!0),w=v(!1);l(w,f,"Iterator Helper"),e.exports=function(e,t,r){var a=function(a,o){o?(o.iterator=a.iterator,o.next=a.next):o=a,o.type=t?g:h,o.returnHandlerResult=!!r,o.nextHandler=e,o.counter=0,o.done=!1,b(this,o)};return a.prototype=t?y:w,a}}}]);
//# sourceMappingURL=264.9ca01aac.js.map